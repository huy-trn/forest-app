services:
  web:
    image: ${IMAGE_NAME}:${IMAGE_TAG}
    build: null
    command: ["sh", "-c", "npm run start"]

  nginx:
    image: nginx:1.25-alpine
    depends_on:
      - web
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN_NAME: ${DOMAIN_NAME:-${EC2_HOST:?EC2_HOST required}}
    volumes:
      - ./deploy/nginx:/etc/nginx/templates:ro
      - certbot-web:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
    command: >
      sh -c "template=/etc/nginx/templates/app.conf.tmpl;
      if [ -f /etc/letsencrypt/live/$${DOMAIN_NAME}/fullchain.pem ]; then
        template=/etc/nginx/templates/app.ssl.conf.tmpl;
      fi;
      envsubst '$$DOMAIN_NAME' < $$template > /etc/nginx/conf.d/default.conf;
      nginx;
      while true; do
        if [ -f /etc/letsencrypt/live/$${DOMAIN_NAME}/fullchain.pem ]; then
          template=/etc/nginx/templates/app.ssl.conf.tmpl;
        else
          template=/etc/nginx/templates/app.conf.tmpl;
        fi;
        envsubst '$$DOMAIN_NAME' < $$template > /etc/nginx/conf.d/default.conf;
        nginx -s reload || true;
        sleep 12h;
      done"

  certbot:
    image: certbot/certbot:latest
    environment:
      DOMAIN_NAME: ${DOMAIN_NAME:-${EC2_HOST:?EC2_HOST required}}
      CERTBOT_EMAIL: ${CERTBOT_EMAIL:?CERTBOT_EMAIL required}
    dns:
      - 1.1.1.1
      - 8.8.8.8
    volumes:
      - certbot-web:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
    entrypoint: /bin/sh
    command: >
      -c "if [ ! -f /etc/letsencrypt/live/$${DOMAIN_NAME}/fullchain.pem ]; then
            certbot certonly --non-interactive --agree-tos --email $${CERTBOT_EMAIL} --webroot -w /var/www/certbot -d $${DOMAIN_NAME};
          fi;
          while true; do
            certbot renew --webroot -w /var/www/certbot --quiet || true;
            sleep 12h;
          done"

volumes:
  certbot-web:
  letsencrypt:
